<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Add Job Details</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="admin-panel" class="admin-container">
      <h1>➕ Add a New Job - Step 2</h1>

      <form id="detailsForm" class="job-form">
        <div class="form-group">
          <label for="salary">Salary</label>
          <input
            type="text"
            id="salary"
            placeholder="e.g., $60,000 - $80,000"
          />
        </div>

        <div class="form-group">
          <label for="experience">Experience Required</label>
          <input type="text" id="experience" placeholder="e.g., 2+ years" />
        </div>

        <div class="form-group">
          <label for="employmentType">Employment Type</label>
          <select id="employmentType">
            <option value="">Select Type</option>
            <option value="Full-time">Full-time</option>
            <option value="Part-time">Part-time</option>
            <option value="Contract">Contract</option>
            <option value="Internship">Internship</option>
            <option value="Temporary">Temporary</option>
          </select>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="benefits">Benefits (comma separated)</label>
          <input type="text" id="benefits" />
        </div>

        <div class="form-group">
          <label for="requirements">Requirements (comma separated)</label>
          <input type="text" id="requirements" />
        </div>

        <div class="form-group">
          <label for="applicationDeadline">Application Deadline</label>
          <input type="date" id="applicationDeadline" />
        </div>

        <button type="submit" class="btn-primary">Submit Job</button>
      </form>

      <a class="back-link" href="admin.html">← Back to Basic Info</a>
      <p id="message" class="form-message"></p>
    </div>

    <script>
      const detailsForm = document.getElementById("detailsForm");
      const message = document.getElementById("message");

      // Load partial job data from sessionStorage on page load
      window.addEventListener("DOMContentLoaded", () => {
        const partialJob = sessionStorage.getItem("partialJobData");
        if (!partialJob) {
          // If no partial data, redirect back to step 1
          window.location.href = "admin.html";
          return;
        }
      });

      detailsForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Retrieve partial data
        const partialJob = JSON.parse(sessionStorage.getItem("partialJobData"));
        if (!partialJob) {
          message.textContent =
            "❌ Missing job basic info. Please start again.";
          message.className = "form-message error";
          return;
        }

        // Collect the additional details
        const jobDetails = {
          salary: document.getElementById("salary").value.trim(),
          experience: document.getElementById("experience").value.trim(),
          employmentType: document.getElementById("employmentType").value,
          description: document.getElementById("description").value.trim(),
          benefits: document
            .getElementById("benefits")
            .value.split(",")
            .map((s) => s.trim())
            .filter((s) => s.length > 0),
          requirements: document
            .getElementById("requirements")
            .value.split(",")
            .map((s) => s.trim())
            .filter((s) => s.length > 0),
          applicationDeadline: document.getElementById("applicationDeadline")
            .value,
        };

        // Merge partial and detailed info into one job object
        const completeJob = { ...partialJob, ...jobDetails };

        try {
          const res = await fetch("/api/jobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(completeJob),
          });

          const resData = await res.json();

          if (!res.ok) {
            message.textContent = "❌ " + resData.error;
            message.className = "form-message error";
            return;
          }

          message.textContent = "✅ Job added successfully!";
          message.className = "form-message success";

          // Clear session storage and reset form
          sessionStorage.removeItem("partialJobData");
          detailsForm.reset();

          // Optionally redirect to the job board or admin panel home
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        } catch (err) {
          console.error("Network error:", err);
          message.textContent = "❌ Network error: " + err.message;
          message.className = "form-message error";
        }
      });
    </script>
  </body>
</html>
